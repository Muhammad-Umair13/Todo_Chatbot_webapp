["spec.md](spec.md) | **Plan**: [plan.md](plan.md) | **Research**: [research.md](research.md)\n**Purpose**: Define the complete data model for the Phase II Task entity with all fields, validation rules, and relationships.\n\n## Overview\n\nThis document defines the data model for the Task entity, including fields, validation rules, state transitions, and database constraints.\n\n---\n\n## Entity: Task\n\n### Purpose\n\nRepresents a user's todo item in the Phase II Todo Web Application. Each task is owned by exactly one user and can be independently queried, created, and modified.\n\n### Canonical Definition\n\n```python\nfrom sqlmodel import SQLModel, Field\nfrom datetime import datetime\nfrom typing import Optional\n\nclass Task(SQLModel, table=True):\n    \"\"\"Task entity for storing user todo items.\"\"\"\n    \n    # Primary Key\n    id: Optional[int] = Field(\n        default=None,\n        primary_key=True,\n        description=\"Unique identifier for the task (auto-increment)\"\n    )\n    \n    # Ownership\n    user_id: str = Field(\n        index=True,\n        description=\"User identifier extracted from JWT (foreign key to auth system)\"\n    )\n    \n    # Task Data\n    title: str = Field(\n        description=\"Short task title (minimum 1 character)\"\n    )\n    \n    description: str = Field(\n        default=\"\",\n        max_length=1000,\n        description=\"Optional task details (maximum 1000 characters)\"\n    )\n    \n    # State\n    completed: bool = Field(\n        default=False,\n        description=\"Task completion status (defaults to False)\"\n    )\n    \n    # Timestamps\n    created_at: datetime = Field(\n        default_factory=datetime.utcnow,\n        description=\"Creation timestamp (UTC)\"\n    )\n    \n    updated_at: datetime = Field(\n        default_factory=datetime.utcnow,\n        description=\"Last update timestamp (UTC)\"\n    )\n```\n\n### Field Specifications\n\n| Field | Type | Required | Default | Description |\n|-------|------|----------|---------|-------------|\n| `id` | `int` (optional) | Yes | Auto-increment | Primary key, unique identifier for the task |\n| `user_id` | `str` | Yes | None | User identifier from JWT, establishes ownership |\n| `title` | `str` | Yes | None | Task title, minimum 1 character |\n| `description` | `str` | No | Empty string | Optional task details, maximum 1000 characters |\n| `completed` | `bool` | Yes | `False` | Task completion status |\n| `created_at` | `datetime` | Yes | Current UTC | Timestamp when task was created |\n| `updated_at` | `datetime` | Yes | Current UTC | Timestamp when task was last modified |\n\n---\n\n## Validation Rules\n\n### Title Validation\n- **Required**: Must contain at least 1 character\n- **Type**: String\n- **Encoding**: UTF-8\n- **Truncation**: Not allowed - must reject if too long\n\n**Implementation**:\n```python\nfrom pydantic import field_validator\n\nclass TaskBase(SQLModel):\n    title: str\n    \n    @field_validator('title')\n    @classmethod\n    def title_min_length(cls, v: str) -> str:\n        if len(v) < 1:\n            raise ValueError('title must be at least 1 character')\n        return v\n```\n\n### Description Validation\n- **Required**: No (optional field)\n- **Maximum Length**: 1000 characters\n- **Type**: String\n- **Encoding**: UTF-8\n- **Truncation**: Not allowed - must reject if too long\n\n**Implementation**:\n```python\nclass TaskBase(SQLModel):\n    description: str = \"\"\n    \n    @field_validator('description')\n    @classmethod\n    def description_max_length(cls, v: str) -> str:\n        if len(v) > 1000:\n            raise ValueError('description must be at most 1000 characters')\n        return v\n```\n\n### Completed Status\n- **Required**: Yes\n- **Default Value**: `False`\n- **Type**: Boolean\n- **Allowed Values**: `true` or `false`\n\n**Implementation**:\n```python\nclass TaskCreate(SQLModel):\n    completed: bool = False  # Defaults to False on create\n```\n\n### Timestamp Validation\n- **Required**: Yes\n- **Default Value**: Current UTC time\n- **Type**: DateTime\n- **Timezone**: UTC (coordinated universal time)\n- **Auto-update**: `updated_at` is set on every modification\n\n**Implementation**:\n```python\nfrom datetime import datetime\nfrom sqlalchemy import event\nfrom sqlalchemy.orm import Mapper\n\nclass Task(SQLModel, table=True):\n    created_at: datetime = Field(default_factory=datetime.utcnow)\n    updated_at: datetime = Field(default_factory=datetime.utcnow)\n\n@event.listens_for(Task, 'before_update')\ndef update_timestamp(mapper: Mapper, connection, target: Task) -> None:\n    target.updated_at = datetime.utcnow()\n```\n\n---\n\n## Database Constraints\n\n### Primary Key Constraint\n```sql\nPRIMARY KEY (id)\n```\n- Ensures each task has a unique identifier\n- Auto-increment by PostgreSQL\n\n### Ownership Constraint\n```sql\nNOT NULL (user_id)\n```\n- Every task must belong to exactly one user\n- Enforced at database level\n- Backend MUST filter queries by user_id\n\n### Nullability Rules\n- `id`: Can be None before insert (auto-increment), NOT NULL after insert\n- `user_id`: NOT NULL\n- `title`: NOT NULL\n- `description`: Nullable (defaults to empty string)\n- `completed`: NOT NULL\n- `created_at`: NOT NULL\n- `updated_at`: NOT NULL\n\n### Unique Constraints\n- No additional unique constraints beyond primary key\n- Same user can have multiple tasks with same title (intentional)\n\n---\n\n## Indexes\n\n### Index 1: user_id\n```sql\nCREATE INDEX ix_task_user_id ON task (user_id);\n```\n**Purpose**: Enables fast per-user task queries\n**Use Case**: `WHERE user_id = ?`\n**Impact**: O(log n) lookup instead of O(n)\n\n### Index 2: user_id + completed\n```sql\nCREATE INDEX ix_task_user_id_completed ON task (user_id, completed);\n```\n**Purpose**: Enables filtered task lists (completed/active)\n**Use Case**: `WHERE user_id = ? AND completed = ?`\n**Impact**: O(log n) lookup for filtered queries\n**Composite Benefit**: Index covers both columns, can be used for either column alone\n\n### Index Analysis\n\n| Query Pattern | Index Used | Complexity |\n|--------------|------------|------------|\n| `SELECT * FROM task WHERE user_id = ?` | `ix_task_user_id` | O(log n) |\n| `SELECT * FROM task WHERE user_id = ? AND completed = ?` | `ix_task_user_id_completed` | O(log n) |\n| `SELECT * FROM task WHERE id = ?` | Primary key | O(log n) |\n| `SELECT * FROM task WHERE completed = ?` | Full table scan | O(n) - intentional, requires user_id |\n\n**Note**: Queries without user_id filter intentionally perform poorly to enforce ownership pattern.\n\n---\n\n## State Transitions\n\n### Task Lifecycle\n\n```\nCreated (completed=False)\n    |\n    |--- User marks complete ---> Completed (completed=True)\n    |\n    |--- User marks incomplete ---> Completed (completed=False)\n```\n\n### Valid Transitions\n\n| From State | To State | Operation |\n|------------|----------|-----------|\n| Created | Completed | Mark task as complete |\n| Created | Created | Update title or description |\n| Completed | Completed | Update title or description |\n| Completed | Created | Mark task as incomplete |\n\n### State Machine\n\n```python\nfrom enum import Enum\n\nclass TaskState(str, Enum):\n    ACTIVE = \"active\"\n    COMPLETED = \"completed\"\n\ndef get_state(task: Task) -> TaskState:\n    return TaskState.COMPLETED if task.completed else TaskState.ACTIVE\n```\n\n---\n\n## Relationships\n\n### Entity Relationship Diagram\n\n```\n+-------------+\n|   User      | (External - Better Auth)\n+-------------+\n      |\n      | 1\n      |\n      | user_id\n      |\n      | N\n+-------------+        +-------------+\n|    Task     |------->|   Task      |\n+-------------+  user_id +-------------+\n```\n\n### Relationship Rules\n\n1. **User to Tasks**: One-to-Many\n   - One user can have zero or more tasks\n   - Each task belongs to exactly one user\n   - `user_id` is a foreign key reference (no actual foreign key constraint in database, logical only)\n\n2. **No Direct User Table in Backend**\n   - User management is handled by Better Auth (external)\n   - Backend stores only user_id string\n   - No database relationship constraint (logical only)\n\n3. **Task Isolation**\n   - Tasks from different users never intersect\n   - All queries MUST filter by user_id\n   - Cross-user access prohibited\n\n---\n\n## Data Operations\n\n### Create Operation\n\n**Input**: `TaskCreate` (title, optional description, completed defaults to False)\n**Output**: `Task` (with id, user_id, created_at, updated_at populated)\n**Side Effects**: \n- `created_at` set to current UTC time\n- `updated_at` set to current UTC time\n- `user_id` set from JWT token\n\n**Implementation**:\n```python\nclass TaskCreate(SQLModel):\n    title: str\n    description: str = \"\"\n    completed: bool = False\n```\n\n### Read Operation\n\n**Input**: `task_id` and `user_id`\n**Output**: `Task` or None\n**Side Effects**: None\n**Constraint**: Only return task if `user_id` matches\n\n### Update Operation\n\n**Input**: `task_id`, `user_id`, `TaskUpdate` (partial fields)\n**Output**: Updated `Task`\n**Side Effects**: `updated_at` set to current UTC time\n**Constraint**: Only update task if `user_id` matches\n\n**Implementation**:\n```python\nclass TaskUpdate(SQLModel):\n    title: Optional[str] = None\n    description: Optional[str] = None\n    completed: Optional[bool] = None\n```\n\n### Delete Operation\n\n**Input**: `task_id` and `user_id`\n**Output**: None\n**Side Effects**: Task permanently removed from database\n**Constraint**: Only delete task if `user_id` matches\n\n### List Operation\n\n**Input**: `user_id`, optional `completed` filter\n**Output**: List of `Task` objects\n**Side Effects**: None\n**Constraint**: Only return tasks where `user_id` matches\n\n---\n\n## Schema Evolution\n\n### Phase II Schema (Current)\n- Core fields: id, user_id, title, description, completed, created_at, updated_at\n- Indexes: user_id, (user_id, completed)\n- No soft deletes\n- No priority\n- No due_date\n- No tags\n\n### Phase III Compatibility (Forward)\n- Service layer pattern enables programmatic access\n- Stateless operations support MCP tools\n- No schema changes required for Phase III\n- Additional indexes can be added without breaking changes\n\n### Future Phases (Not in Scope)\nThe following are reserved for later phases and NOT included in Phase II:\n- Priority field\n- Due date field\n- Tags/categories\n- Soft delete (is_deleted flag)\n- Audit logging\n- Event streaming\n\n---\n\n## Summary\n\nThe Task data model provides:\n- \u2705 User ownership through user_id field\n- \u2705 Validation rules for title and description\n- \u2705 Automatic timestamp management\n- \u2705 Efficient querying via indexes\n- \u2705 State transitions for completion status\n- \u2705 Forward compatibility with Phase III\n- \u2705 Clear separation from user management (Better Auth)\n\n**Status**: \u2705 Complete and ready for implementation"]